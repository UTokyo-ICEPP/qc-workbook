

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>量子機械学習を使った新しい素粒子現象の探索 &#8212; 量子コンピューティング・ワークブック</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'vqc_machine_learning';</script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="【課題】量子カーネルを使った新現象の分類" href="qkc_machine_learning.html" />
    <link rel="prev" title="【課題】高エネルギー実験で生成された荷電粒子の飛跡を見つける" href="vqe_tracking.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="welcome.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/favicon.ico" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/favicon.ico" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="welcome.html">
                    量子コンピューティング・ワークブックへようこそ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">量子コンピュータに触れる</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chsh_inequality.html">CHSH不等式の破れを確認する</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonlocal_correlations.html">【課題】量子相関を調べる</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">量子回路を作る</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="circuit_from_scratch.html">単純な量子回路をゼロから書く</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_computation.html">【課題】アダマールテスト</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">量子コンピュータでの並列計算</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="extreme_simd.html">計算をする量子回路の実装</a></li>
<li class="toctree-l1"><a class="reference internal" href="dynamics_simulation.html">物理系を表現する</a></li>
<li class="toctree-l1"><a class="reference internal" href="more_dynamics.html">【課題】量子ダイナミクスシミュレーション・続</a></li>
<li class="toctree-l1"><a class="reference internal" href="addition_on_ibmq.html">【参考】足し算を実機で行う</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ショアのアルゴリズム</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="shor.html">素因数分解アルゴリズムを学習する</a></li>
<li class="toctree-l1"><a class="reference internal" href="spectrum_estimation.html">【課題】位相推定によるスペクトル分解</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">グローバーのアルゴリズム</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="grover.html">データベース検索を行う</a></li>
<li class="toctree-l1"><a class="reference internal" href="grover_number_light.html">【課題】ビット反転ボードの操作を見つける</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">変分法と変分量子固有値ソルバー</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="vqe.html">変分法と変分量子固有値ソルバー法を学習する</a></li>
<li class="toctree-l1"><a class="reference internal" href="vqe_tracking.html">【課題】高エネルギー実験で生成された荷電粒子の飛跡を見つける</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">量子・古典ハイブリッド機械学習</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">量子機械学習を使った新しい素粒子現象の探索</a></li>
<li class="toctree-l1"><a class="reference internal" href="qkc_machine_learning.html">【課題】量子カーネルを使った新現象の分類</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">演習</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="toffoli_shor_code.html">ToffoliゲートとShorコード</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">補足</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">実習の準備</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_intro.html">予備知識：Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="numerics.html">予備知識：数値表現</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">参考文献</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">文献一覧</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/UTokyo-ICEPP/qc-workbook/master?urlpath=lab/tree/vqc_machine_learning.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/UTokyo-ICEPP/qc-workbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/UTokyo-ICEPP/qc-workbook/issues/new?title=Issue%20on%20page%20%2Fvqc_machine_learning.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/vqc_machine_learning.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="_sources/vqc_machine_learning.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>量子機械学習を使った新しい素粒子現象の探索</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-introduction-a">はじめに <a id="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-ml-a">機械学習と深層学習 <a id="ml"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-qml-a">量子回路学習<a id="qml"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-example-a">初歩的な例<a id="example"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-data-a">学習データの準備<a id="func_data"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-state-preparation-a">量子状態の生成<a id="func_state_preparation"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-variational-form-a">変分フォームを使った状態変換<a id="func_variational_form"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#u-boldsymbol-theta">変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の構成</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2量子ビットゲートの作成</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">回転ゲートと<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の作成</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-measurement-a">測定とモデル出力<a id="func_measurement"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-a">素粒子現象の探索への応用<a id="susy"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-data-a">学習データの準備<a id="susy_data"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-state-preparation-a">量子状態の生成<a id="susy_state_preparation"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-variational-form-a">変分フォームを使った状態変換<a id="susy_variational_form"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-measurement-a">測定とモデル出力<a id="susy_measurement"></a></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>量子機械学習を使った新しい素粒子現象の探索<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h1>
<p>この実習では、<strong>量子・古典ハイブリッドアルゴリズム</strong>の応用である<strong>量子機械学習</strong>の基本的な実装を学んだのち、その活用例として、<strong>素粒子実験での新粒子探索</strong>への応用を考えます。ここで学ぶ量子機械学習の手法は、変分量子アルゴリズムの応用として提案された、<strong>量子回路学習</strong>と呼ばれる学習手法<span id="id2">[<a class="reference internal" href="bibliography.html#id24" title="K. Mitarai, M. Negoro, M. Kitagawa, and K. Fujii. Quantum circuit learning. Phys. Rev. A, 98:032309, Sep 2018. URL: https://link.aps.org/doi/10.1103/PhysRevA.98.032309, doi:10.1103/PhysRevA.98.032309.">MNKF18</a>]</span>です。</p>
<div class="contents local topic" id="id3">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#a-id-introduction-a" id="id11">はじめに <a id='introduction'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-ml-a" id="id12">機械学習と深層学習 <a id='ml'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-qml-a" id="id13">量子回路学習<a id='qml'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-example-a" id="id14">初歩的な例<a id='example'></a></a></p>
<ul>
<li><p><a class="reference internal" href="#a-id-func-data-a" id="id15">学習データの準備<a id='func_data'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-func-state-preparation-a" id="id16">量子状態の生成<a id='func_state_preparation'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-func-variational-form-a" id="id17">変分フォームを使った状態変換<a id='func_variational_form'></a></a></p>
<ul>
<li><p><a class="reference internal" href="#u-boldsymbol-theta" id="id18">変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の構成</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id19">2量子ビットゲートの作成</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id20">回転ゲートと<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の作成</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#a-id-func-measurement-a" id="id21">測定とモデル出力<a id='func_measurement'></a></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#a-id-susy-a" id="id22">素粒子現象の探索への応用<a id='susy'></a></a></p>
<ul>
<li><p><a class="reference internal" href="#a-id-susy-data-a" id="id23">学習データの準備<a id='susy_data'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-susy-state-preparation-a" id="id24">量子状態の生成<a id='susy_state_preparation'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-susy-variational-form-a" id="id25">変分フォームを使った状態変換<a id='susy_variational_form'></a></a></p></li>
<li><p><a class="reference internal" href="#a-id-susy-measurement-a" id="id26">測定とモデル出力<a id='susy_measurement'></a></a></p></li>
</ul>
</li>
</ul>
</div>
<p><span class="math notranslate nohighlight">\(\newcommand{\ket}[1]{| #1 \rangle}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\expval}[3]{\langle #1 | #2 | #3 \rangle}\)</span></p>
<section id="a-id-introduction-a">
<h2><a class="toc-backref" href="#id11">はじめに <a id='introduction'></a></a><a class="headerlink" href="#a-id-introduction-a" title="Permalink to this heading">#</a></h2>
<p>近年、機械学習の分野において<strong>深層学習</strong>（<strong>ディープラーニング</strong>）が注目を浴びています。ディープラーニングは<strong>ニューラルネットワーク</strong>の隠れ層を多層にすることで、入力と出力の間の複雑な関係を学習することができます。その学習結果を使って、新しい入力データに対して出力を予測することが可能になります。ここで学習する量子機械学習アルゴリズムは、このニューラルネットワークの部分を変分量子回路に置き換えたものです。つまり、ニューラルネットワークでの各ニューロン層への重みを調節する代わりに、変分量子回路のパラメータ（例えば回転ゲートの回転角）を調整することで入力と出力の関係を学習しようという試みです。
量子力学の重ね合わせの原理から、<strong>指数関数的に増える多数の計算基底</strong>を使って状態を表現できることが量子コンピュータの強みです。この強みを生かすことで、データ間の複雑な相関を学習できる可能性が生まれます。そこに量子機械学習の最も大きな強みがあると考えられています。</p>
<p>多項式で与えられる数の量子ゲートを使って、指数関数的に増える関数を表現できる可能性があるところに量子機械学習の強みがありますが、誤り訂正機能を持たない中規模の量子コンピュータ (<em>Noisy Intermediate-Scale Quantum</em>デバイス, 略してNISQ）で、古典計算を上回る性能を発揮できるか確証はありません。しかしNISQデバイスでの動作に適したアルゴリズムであるため、2019年3月にはIBMの実験チームによる実機での実装がすでに行われ、結果も論文<span id="id4">[<a class="reference internal" href="bibliography.html#id25" title="Vojtěch Havlíček, Antonio D. Córcoles, Kristan Temme, Aram W. Harrow, Abhinav Kandala, Jerry M. Chow, and Jay M. Gambetta. Supervised learning with quantum-enhanced feature spaces. Nature, 567(7747):209–212, 2019. URL: https://doi.org/10.1038/s41586-019-0980-2, doi:10.1038/s41586-019-0980-2.">HavlivcekCorcolesT+19</a>]</span>として出版されています。</p>
</section>
<section id="a-id-ml-a">
<h2><a class="toc-backref" href="#id12">機械学習と深層学習 <a id='ml'></a></a><a class="headerlink" href="#a-id-ml-a" title="Permalink to this heading">#</a></h2>
<p>機械学習を一言で（大雑把に）説明すると、与えられたデータを元に、ある予測を返すような機械を実現する工程だと言えます。例えば、2種類の変数<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>と<span class="math notranslate nohighlight">\(\mathbf{y}\)</span>からなるデータ（<span class="math notranslate nohighlight">\((x_i, y_i)\)</span>を要素とするベクトル、<span class="math notranslate nohighlight">\(i\)</span>は要素の添字）があったとして、その変数間の関係を求める問題として機械学習を考えてみましょう。つまり、変数<span class="math notranslate nohighlight">\(x_i\)</span>を引数とする関数<span class="math notranslate nohighlight">\(f\)</span>を考え、その出力<span class="math notranslate nohighlight">\(\tilde{y_i}=f(x_i)\)</span>が<span class="math notranslate nohighlight">\(\tilde{y}_i\simeq y_i\)</span>となるような関数<span class="math notranslate nohighlight">\(f\)</span>をデータから近似的に求めることに対応します。
一般的に、この関数<span class="math notranslate nohighlight">\(f\)</span>は変数<span class="math notranslate nohighlight">\(x\)</span>以外のパラメータを持っているでしょう。なので、そのパラメータ<span class="math notranslate nohighlight">\(\mathbf{w}\)</span>をうまく調整して、<span class="math notranslate nohighlight">\(y_i\simeq\tilde{y}_i\)</span>となる関数<span class="math notranslate nohighlight">\(f=f(x,\mathbf{w}^*)\)</span>とパラメータ<span class="math notranslate nohighlight">\(\mathbf{w}^*\)</span>を求めることが機械学習の鍵になります。</p>
<p>関数<span class="math notranslate nohighlight">\(f\)</span>を近似する方法の一つとして、現在主流になっているのが脳のニューロン構造を模式化したニューラルネットワークです。下図に示しているのは、ニューラルネットの基本的な構造です。丸で示しているのが構成ユニット（ニューロン）で、ニューロンを繋ぐ情報の流れを矢印で表しています。ニューラルネットには様々な構造が考えられますが、基本になるのは図に示したような層構造で、前層にあるニューロンの出力が次の層にあるニューロンへの入力になります。入力データ<span class="math notranslate nohighlight">\(x\)</span>を受ける入力層と出力<span class="math notranslate nohighlight">\(\tilde{y}\)</span>を出す出力層に加え、中間に複数の「隠れ層」を持つものを総称して深層ニューラルネットワークと呼びます。</p>
<a class="reference internal image-reference" href="_images/neural_net.png"><img alt="var_circuit" class="align-center" src="_images/neural_net.png" style="width: 500px;" /></a>
<p>では、もう少し数学的なモデルを見てみましょう。<span class="math notranslate nohighlight">\(l\)</span>層目にある<span class="math notranslate nohighlight">\(j\)</span>番目のユニット<span class="math notranslate nohighlight">\(u_j^l\)</span>に対して、前層（<span class="math notranslate nohighlight">\(l-1\)</span>番目）から<span class="math notranslate nohighlight">\(n\)</span>個の入力<span class="math notranslate nohighlight">\(o_k^{l-1}\)</span> (<span class="math notranslate nohighlight">\(k=1,2,\cdots n\)</span>) がある場合、入力<span class="math notranslate nohighlight">\(o_k^{l-1}\)</span>への重みパラメータ<span class="math notranslate nohighlight">\(w_k^l\)</span>を使って</p>
<div class="math notranslate nohighlight">
\[
o_j^l=g\left(\sum_{k=1}^n o_k^{l-1}w_k^l\right)
\]</div>
<p>となる出力<span class="math notranslate nohighlight">\(o_j^l\)</span>を考えます。図で示すと</p>
<a class="reference internal image-reference" href="_images/neuron.png"><img alt="var_circuit" class="align-center" src="_images/neuron.png" style="width: 350px;" /></a>
<p>になります。関数<span class="math notranslate nohighlight">\(g\)</span>は活性化関数と呼ばれ、入力に対して非線形な出力を与えます。活性化関数としては、一般的にはシグモイド関数やReLU（Rectified Linear Unit）等の関数が用いられることが多いです。</p>
<p>関数<span class="math notranslate nohighlight">\(f(x,\mathbf{w}^*)\)</span>を求めるために、最適なパラメータ<span class="math notranslate nohighlight">\(\mathbf{w}^*\)</span>を決定するプロセス（学習と呼ばれる）が必要です。そのために、出力<span class="math notranslate nohighlight">\(\tilde{y}\)</span>とターゲットとなる変数<span class="math notranslate nohighlight">\(y\)</span>の差を測定する関数<span class="math notranslate nohighlight">\(L(\mathbf{w})\)</span>を考えます（一般に損失関数やコスト関数と呼ばれます）。</p>
<div class="math notranslate nohighlight">
\[
L(\mathbf{w}) = \frac{1}{N}\sum_{i=1}^N L(f(x_i,\mathbf{w}),y_i)
\]</div>
<p><span class="math notranslate nohighlight">\(N\)</span>は<span class="math notranslate nohighlight">\((x_i, y_i)\)</span>データの数です。この損失関数<span class="math notranslate nohighlight">\(L(\mathbf{w})\)</span>を最小化するパラメータ<span class="math notranslate nohighlight">\(\mathbf{w}^*\)</span>を求めたいわけですが、それには誤差逆伝搬法と呼ばれる手法を使うことができることが知られています。この手法は、<span class="math notranslate nohighlight">\(L(\mathbf{w})\)</span>の各<span class="math notranslate nohighlight">\(w\)</span>に対する微分係数<span class="math notranslate nohighlight">\(\Delta_w L(\mathbf{w})\)</span>を求めて、</p>
<div class="math notranslate nohighlight">
\[
w'=w-\epsilon\Delta_w L(\mathbf{w})
\]</div>
<p>のように<span class="math notranslate nohighlight">\(w\)</span>を更新することで、<span class="math notranslate nohighlight">\(L(\mathbf{w})\)</span>を最小化するというものです（<span class="math notranslate nohighlight">\(w\)</span>と<span class="math notranslate nohighlight">\(w'\)</span>は更新前と更新後のパラメータ）。<span class="math notranslate nohighlight">\(\epsilon\:(&gt;0)\)</span>は学習率と呼ばれるパラメータで、これは基本的には私たちが手で決めてやる必要があります。</p>
</section>
<section id="a-id-qml-a">
<h2><a class="toc-backref" href="#id13">量子回路学習<a id='qml'></a></a><a class="headerlink" href="#a-id-qml-a" title="Permalink to this heading">#</a></h2>
<p>変分量子回路を用いた量子回路学習アルゴリズムは、一般的には以下のような順番で量子回路に実装され、計算が行われます。</p>
<ol class="arabic simple">
<li><p><strong>学習データ</strong><span class="math notranslate nohighlight">\(\{(\mathbf{x}_i, y_i)\}\)</span>を用意する。<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>は入力データのベクトル、<span class="math notranslate nohighlight">\(y_i\)</span>は入力データに対する真の値（教師データ）とする（<span class="math notranslate nohighlight">\(i\)</span>は学習データのサンプルを表す添字）。</p></li>
<li><p>入力<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>から何らかの規則で決まる回路<span class="math notranslate nohighlight">\(U_{\text{in}}(\mathbf{x})\)</span>（<strong>特徴量マップ</strong>と呼ぶ）を用意し、<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>の情報を埋め込んだ入力状態<span class="math notranslate nohighlight">\(\ket{\psi_{\text{in}}(\mathbf{x}_i)} = U_{\text{in}}(\mathbf{x}_i)\ket{0}\)</span>を作る。</p></li>
<li><p>入力状態にパラメータ<span class="math notranslate nohighlight">\(\boldsymbol{\theta}\)</span>に依存したゲート<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>（<strong>変分フォーム</strong>）を掛けたものを出力状態<span class="math notranslate nohighlight">\(\ket{\psi_{\text{out}}(\mathbf{x}_i,\boldsymbol{\theta})} = U(\boldsymbol{\theta})\ket{\psi_{\text{in}}(\mathbf{x}_i)}\)</span>とする。</p></li>
<li><p>出力状態のもとで何らかの<strong>観測量</strong>を測定し、測定値<span class="math notranslate nohighlight">\(O\)</span>を得る。例えば、最初の量子ビットで測定したパウリ<span class="math notranslate nohighlight">\(Z\)</span>演算子の期待値<span class="math notranslate nohighlight">\(\langle Z_1\rangle = \expval{\psi_{\text{out}}}{Z_1}{\psi_{\text{out}}}\)</span>などを考える。</p></li>
<li><p><span class="math notranslate nohighlight">\(F\)</span>を適当な関数として、<span class="math notranslate nohighlight">\(F(O)\)</span>をモデルの出力<span class="math notranslate nohighlight">\(y(\mathbf{x}_i,\boldsymbol{\theta})\)</span>とする。</p></li>
<li><p>真の値<span class="math notranslate nohighlight">\(y_i\)</span>と出力<span class="math notranslate nohighlight">\(y(\mathbf{x}_i,\boldsymbol{\theta})\)</span>の間の乖離を表す<strong>コスト関数</strong><span class="math notranslate nohighlight">\(L(\boldsymbol{\theta})\)</span>を定義し、古典計算でコスト関数を計算する。</p></li>
<li><p><span class="math notranslate nohighlight">\(L(\boldsymbol{\theta})\)</span>が小さくなるように<span class="math notranslate nohighlight">\(\boldsymbol{\theta}\)</span>を更新する。</p></li>
<li><p>3-7のプロセスを繰り返すことで、コスト関数を最小化する<span class="math notranslate nohighlight">\(\boldsymbol{\theta}=\boldsymbol{\theta^*}\)</span>を求める。</p></li>
<li><p><span class="math notranslate nohighlight">\(y(\mathbf{x},\boldsymbol{\theta^*})\)</span>が学習によって得られた<strong>予測モデル</strong>になる。</p></li>
</ol>
<a class="reference internal image-reference" href="_images/var_circuit.png"><img alt="var_circuit" class="align-center" src="_images/var_circuit.png" style="width: 700px;" /></a>
<p>この順に量子回路学習アルゴリズムを実装していきましょう。まず、必要なライブラリを最初にインポートします。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">ParameterVector</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.library</span> <span class="kn">import</span> <span class="n">TwoLocal</span><span class="p">,</span> <span class="n">ZFeatureMap</span><span class="p">,</span> <span class="n">ZZFeatureMap</span>
<span class="kn">from</span> <span class="nn">qiskit.primitives</span> <span class="kn">import</span> <span class="n">Estimator</span><span class="p">,</span> <span class="n">Sampler</span>
<span class="kn">from</span> <span class="nn">qiskit.quantum_info</span> <span class="kn">import</span> <span class="n">SparsePauliOp</span>
<span class="kn">from</span> <span class="nn">qiskit_machine_learning.algorithms.classifiers</span> <span class="kn">import</span> <span class="n">VQC</span>
<span class="c1">#from qiskit.utils import split_dataset_to_data_and_labels, map_label_to_class_name</span>
<span class="kn">from</span> <span class="nn">qiskit.algorithms.optimizers</span> <span class="kn">import</span> <span class="n">SPSA</span><span class="p">,</span> <span class="n">COBYLA</span>
<span class="kn">from</span> <span class="nn">qiskit_ibm_runtime</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Sampler</span> <span class="k">as</span> <span class="n">RuntimeSampler</span>
<span class="kn">from</span> <span class="nn">qiskit_ibm_runtime.accounts</span> <span class="kn">import</span> <span class="n">AccountNotFoundError</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/dateutil/zoneinfo/__init__.py:26: UserWarning: I/O error(2): No such file or directory
  warnings.warn(&quot;I/O error({0}): {1}&quot;.format(e.errno, e.strerror))
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-id-example-a">
<h2><a class="toc-backref" href="#id14">初歩的な例<a id='example'></a></a><a class="headerlink" href="#a-id-example-a" title="Permalink to this heading">#</a></h2>
<p>ある入力<span class="math notranslate nohighlight">\(\{x_i\}\)</span>と、既知の関数<span class="math notranslate nohighlight">\(f\)</span>による出力<span class="math notranslate nohighlight">\(y_i=f(x_i)\)</span>が学習データとして与えられた時に、そのデータから関数<span class="math notranslate nohighlight">\(f\)</span>を近似的に求める問題を考えてみます。例として、<span class="math notranslate nohighlight">\(f(x)=x^3\)</span>としてみます。</p>
<section id="a-id-func-data-a">
<h3><a class="toc-backref" href="#id15">学習データの準備<a id='func_data'></a></a><a class="headerlink" href="#a-id-func-data-a" title="Permalink to this heading">#</a></h3>
<p>まず、学習データを準備します。<span class="math notranslate nohighlight">\(x_{\text{min}}\)</span>と<span class="math notranslate nohighlight">\(x_{\text{max}}\)</span>の範囲でデータを<code class="docutils literal notranslate"><span class="pre">num_x_train</span></code>個ランダムに取った後、正規分布に従うノイズを追加しておきます。<code class="docutils literal notranslate"><span class="pre">nqubit</span></code>が量子ビット数、<code class="docutils literal notranslate"><span class="pre">nlayer</span></code>が変分フォームのレイヤー数（後述）を表します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

<span class="c1"># Qubit数、変分フォームのレイヤー数、訓練サンプル数の定義など</span>
<span class="n">nqubit</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nlayer</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">num_x_train</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">num_x_validation</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 関数の定義</span>
<span class="n">func_to_learn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span>

<span class="c1"># 学習用データセットの生成</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_x_train</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">func_to_learn</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="c1"># 関数に正規分布ノイズを付加</span>
<span class="n">mag_noise</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">y_train_noise</span> <span class="o">=</span> <span class="n">y_train</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mag_noise</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_x_train</span><span class="p">)</span>

<span class="c1"># 検証用データセットの生成</span>
<span class="n">x_validation</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_x_validation</span><span class="p">)</span>
<span class="n">y_validation</span> <span class="o">=</span> <span class="n">func_to_learn</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mag_noise</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-id-func-state-preparation-a">
<h3><a class="toc-backref" href="#id16">量子状態の生成<a id='func_state_preparation'></a></a><a class="headerlink" href="#a-id-func-state-preparation-a" title="Permalink to this heading">#</a></h3>
<p>次に、入力<span class="math notranslate nohighlight">\(x_i\)</span>を初期状態<span class="math notranslate nohighlight">\(\ket{0}^{\otimes n}\)</span>に埋め込むための回路<span class="math notranslate nohighlight">\(U_{\text{in}}(x_i)\)</span>（特徴量マップ）を作成します。まず参考文献<span id="id5">[<a class="reference internal" href="bibliography.html#id24" title="K. Mitarai, M. Negoro, M. Kitagawa, and K. Fujii. Quantum circuit learning. Phys. Rev. A, 98:032309, Sep 2018. URL: https://link.aps.org/doi/10.1103/PhysRevA.98.032309, doi:10.1103/PhysRevA.98.032309.">MNKF18</a>]</span>に従い、回転ゲート<span class="math notranslate nohighlight">\(R_j^Y(\theta)=e^{-i\theta Y_j/2}\)</span>と<span class="math notranslate nohighlight">\(R_j^Z(\theta)=e^{-i\theta Z_j/2}\)</span>を使って</p>
<div class="math notranslate nohighlight">
\[
U_{\text{in}}(x_i) = \prod_j R_j^Z(\cos^{-1}(x^2))R_j^Y(\sin^{-1}(x))
\]</div>
<p>と定義します。この<span class="math notranslate nohighlight">\(U_{\text{in}}(x_i)\)</span>をゼロの標準状態に適用することで、入力<span class="math notranslate nohighlight">\(x_i\)</span>は<span class="math notranslate nohighlight">\(\ket{\psi_{\text{in}}(x_i)}=U_{\text{in}}(x_i)\ket{0}^{\otimes n}\)</span>という量子状態に変換されることになります。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u_in</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">nqubit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_in&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
    <span class="c1"># parameter.arcsin()はparameterに値vが代入された時にarcsin(v)になるパラメータ表現</span>
    <span class="n">u_in</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>
    <span class="c1"># arccosも同様</span>
    <span class="n">u_in</span><span class="o">.</span><span class="n">rz</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">arccos</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

<span class="n">u_in</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/758b584caa1f2f34d639ecf92482c42b9b2c87fdcbe2131a91d5f245c99e66bf.png" src="_images/758b584caa1f2f34d639ecf92482c42b9b2c87fdcbe2131a91d5f245c99e66bf.png" />
</div>
</div>
</section>
<section id="a-id-func-variational-form-a">
<h3><a class="toc-backref" href="#id17">変分フォームを使った状態変換<a id='func_variational_form'></a></a><a class="headerlink" href="#a-id-func-variational-form-a" title="Permalink to this heading">#</a></h3>
<section id="u-boldsymbol-theta">
<h4><a class="toc-backref" href="#id18">変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の構成</a><a class="headerlink" href="#u-boldsymbol-theta" title="Permalink to this heading">#</a></h4>
<p>次に、最適化すべき変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>を作っていきます。これは以下の3つの手順で行います。</p>
<ol class="arabic simple">
<li><p>2量子ビットゲートの作成（<span class="math notranslate nohighlight">\(\to\)</span> 量子ビットをエンタングルさせる）</p></li>
<li><p>回転ゲートの作成</p></li>
<li><p>1.と2.のゲートを交互に組み合わせ、1つの大きな変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>を作る</p></li>
</ol>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id19">2量子ビットゲートの作成</a><a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h4>
<p>ここではControlled-<span class="math notranslate nohighlight">\(Z\)</span>ゲート（<span class="math notranslate nohighlight">\(CZ\)</span>）を使ってエンタングルさせ、モデルの表現能力を上げることを目指します。</p>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id20">回転ゲートと<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の作成</a><a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h4>
<p><span class="math notranslate nohighlight">\(CZ\)</span>ゲートを使ってエンタングルメントを生成する回路<span class="math notranslate nohighlight">\(U_{\text{ent}}\)</span>と、<span class="math notranslate nohighlight">\(j \:(=1,2,\cdots n)\)</span>番目の量子ビットに適用する回転ゲート</p>
<div class="math notranslate nohighlight">
\[
U_{\text{rot}}(\theta_j^l) = R_j^Y(\theta_{j3}^l)R_j^Z(\theta_{j2}^l)R_j^Y(\theta_{j1}^l)
\]</div>
<p>を掛けたものを組み合わせて、変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>を構成します。ここで<span class="math notranslate nohighlight">\(l\)</span>は量子回路の層を表していて、<span class="math notranslate nohighlight">\(U_{\text{ent}}\)</span>と上記の回転ゲートを合計<span class="math notranslate nohighlight">\(d\)</span>層繰り返すことを意味しています。実際は、この演習では最初に回転ゲート<span class="math notranslate nohighlight">\(U_{\text{rot}}\)</span>を一度適用してから<span class="math notranslate nohighlight">\(d\)</span>層繰り返す構造を使うため、全体としては</p>
<div class="math notranslate nohighlight">
\[
U\left(\{\theta_j^l\}\right) = \prod_{l=1}^d\left(\left(\prod_{j=1}^n U_{\text{rot}}(\theta_j^l)\right) \cdot U_{\text{ent}}\right)\cdot\prod_{j=1}^n U_{\text{rot}}(\theta_j^0)
\]</div>
<p>という形式の変分量子回路を用いることになります。つまり、変分量子回路は全体で<span class="math notranslate nohighlight">\(3n(d+1)\)</span>個のパラメータを含んでいます。<span class="math notranslate nohighlight">\(\boldsymbol{\theta}\)</span>の初期値ですが、<span class="math notranslate nohighlight">\([0, 2\pi]\)</span>の範囲でランダムに設定するものとします。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u_out</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">nqubit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_out&#39;</span><span class="p">)</span>

<span class="c1"># 長さ0のパラメータ配列</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">ParameterVector</span><span class="p">(</span><span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># thetaに一つ要素を追加して最後のパラメータを返す関数</span>
<span class="k">def</span> <span class="nf">new_theta</span><span class="p">():</span>
    <span class="n">theta</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
    <span class="n">u_out</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

<span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
    <span class="n">u_out</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

<span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
    <span class="n">u_out</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

<span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlayer</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
        <span class="n">u_out</span><span class="o">.</span><span class="n">cz</span><span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nqubit</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
        <span class="n">u_out</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
        <span class="n">u_out</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubit</span><span class="p">):</span>
        <span class="n">u_out</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">new_theta</span><span class="p">(),</span> <span class="n">iq</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="si">}</span><span class="s1"> parameters&#39;</span><span class="p">)</span>

<span class="n">theta_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

<span class="n">u_out</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_vals</span><span class="p">)))</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>54 parameters
</pre></div>
</div>
<img alt="_images/b112311c3219dc2de4afc0cb0654359883615793e2c24389adbe7b4e849eb52f.png" src="_images/b112311c3219dc2de4afc0cb0654359883615793e2c24389adbe7b4e849eb52f.png" />
</div>
</div>
</section>
</section>
<section id="a-id-func-measurement-a">
<h3><a class="toc-backref" href="#id21">測定とモデル出力<a id='func_measurement'></a></a><a class="headerlink" href="#a-id-func-measurement-a" title="Permalink to this heading">#</a></h3>
<p>モデルの出力（予測値）として、状態<span class="math notranslate nohighlight">\(\ket{\psi_{\text{out}}(\mathbf{x},\boldsymbol{\theta})}=U(\boldsymbol{\theta})\ket{\psi_{\text{in}}(\mathbf{x})}\)</span>の元で最初の量子ビットを<span class="math notranslate nohighlight">\(Z\)</span>基底で測定した時の期待値を使うことにします。つまり<span class="math notranslate nohighlight">\(y(\mathbf{x},\boldsymbol{\theta}) = \langle Z_0(\mathbf{x},\boldsymbol{\theta}) \rangle = \expval{\psi_{\text{out}}(\mathbf{x},\boldsymbol{\theta})}{Z_0}{\psi_{\text{out}}(\mathbf{x},\boldsymbol{\theta})}\)</span>です。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">nqubit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">u_in</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">u_out</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">bind_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_vals</span><span class="p">))</span>
<span class="n">bind_params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">model</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">(</span><span class="n">bind_params</span><span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a9369bff1ac8ffd8905df536c17d98addacb9ee59bfe2fdb2a54fb9add8b159f.png" src="_images/a9369bff1ac8ffd8905df536c17d98addacb9ee59bfe2fdb2a54fb9add8b159f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 今回はバックエンドを利用しない（量子回路シミュレーションを簡略化した）Estimatorクラスを使う</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">()</span>

<span class="c1"># 与えられたパラメータの値とxの値に対してyの値を計算する</span>
<span class="k">def</span> <span class="nf">yvals</span><span class="p">(</span><span class="n">param_vals</span><span class="p">,</span> <span class="n">x_vals</span><span class="o">=</span><span class="n">x_train</span><span class="p">):</span>
    <span class="n">circuits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_vals</span><span class="p">:</span>
        <span class="c1"># xだけ数値が代入された変分回路</span>
        <span class="n">circuits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">x_val</span><span class="p">}))</span>

    <span class="c1"># 観測量はIIZ（右端が第0量子ビット）</span>
    <span class="n">observable</span> <span class="o">=</span> <span class="n">SparsePauliOp</span><span class="p">(</span><span class="s1">&#39;I&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nqubit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span>

    <span class="c1"># shotsは関数の外で定義</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">circuits</span><span class="p">,</span> <span class="p">[</span><span class="n">observable</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">circuits</span><span class="p">),</span> <span class="p">[</span><span class="n">param_vals</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">circuits</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="n">param_vals</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_train_noise</span> <span class="o">-</span> <span class="n">yvals</span><span class="p">(</span><span class="n">param_vals</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">callback_function</span><span class="p">(</span><span class="n">param_vals</span><span class="p">):</span>
    <span class="c1"># lossesは関数の外で定義</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objective_function</span><span class="p">(</span><span class="n">param_vals</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;COBYLA iteration </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">}</span><span class="s1">: cost=</span><span class="si">{</span><span class="n">losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>コスト関数<span class="math notranslate nohighlight">\(L\)</span>として、モデルの予測値<span class="math notranslate nohighlight">\(y(x_i, \theta)\)</span>と真の値<span class="math notranslate nohighlight">\(y_i\)</span>の平均2乗誤差の総和を使っています。</p>
<p>では、最後にこの回路を実行して、結果を見てみましょう。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># COBYLAの最大ステップ数</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">50</span>
<span class="c1"># COBYLAの収束条件（小さいほどよい近似を目指す）</span>
<span class="n">tol</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="c1"># バックエンドでのショット数</span>
<span class="n">shots</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">COBYLA</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback_function</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_params</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

<span class="n">losses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">min_result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_function</span><span class="p">,</span> <span class="n">initial_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p>コスト値の推移をプロットします。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7f7ce05fcb20&gt;]
</pre></div>
</div>
<img alt="_images/d68c3ccb0212f1e018bf68cf9abbd1171f550ca3412171077558c62ff4cea4d6.png" src="_images/d68c3ccb0212f1e018bf68cf9abbd1171f550ca3412171077558c62ff4cea4d6.png" />
</div>
</div>
<p>最適パラメータ値でのモデルの出力値をx_minからx_maxまで均一にとった100点で確認します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">yvals</span><span class="p">(</span><span class="n">min_result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x_vals</span><span class="o">=</span><span class="n">x_list</span><span class="p">)</span>

<span class="c1"># 結果を図示する</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train_noise</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training Data (w/ Noise)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">func_to_learn</span><span class="p">(</span><span class="n">x_list</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Function&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Function&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c7d3cdd0e9436af872c3790b31279d5800b127e3906111af40335590f33d32b3.png" src="_images/c7d3cdd0e9436af872c3790b31279d5800b127e3906111af40335590f33d32b3.png" />
</div>
</div>
<p>生成された図を確認してください。ノイズを印加した学習データの分布から、元の関数<span class="math notranslate nohighlight">\(f(x)=x^3\)</span>をおおよそ導き出せていることが分かると思います。</p>
<p>この実習では計算を早く収束させるために、COBYLAオプティマイザーをCallする回数の上限<code class="docutils literal notranslate"><span class="pre">maxiter</span></code>を50、計算をストップする精度の許容範囲<code class="docutils literal notranslate"><span class="pre">tol</span></code>を0.05とかなり粗くしています。<code class="docutils literal notranslate"><span class="pre">maxiter</span></code>を大きくするあるいは<code class="docutils literal notranslate"><span class="pre">tol</span></code>を小さくするなどして、関数を近似する精度がどう変わるか確かめてみてください（ただ同時に<code class="docutils literal notranslate"><span class="pre">maxiter</span></code>を大きくかつ<code class="docutils literal notranslate"><span class="pre">tol</span></code>を小さくしすぎると、計算に非常に時間がかかります）。</p>
</section>
</section>
<section id="a-id-susy-a">
<h2><a class="toc-backref" href="#id22">素粒子現象の探索への応用<a id='susy'></a></a><a class="headerlink" href="#a-id-susy-a" title="Permalink to this heading">#</a></h2>
<p>次の実習課題では、素粒子物理の基本理論（<strong>標準模型</strong>と呼ばれる）を超える新しい理論の枠組みとして知られている「<strong>超対称性理論</strong>」（<em>Supersymmetry</em>、略してSUSY）で存在が予言されている新粒子の探索を考えてみます。</p>
<p>左下の図は、グルーオン<span class="math notranslate nohighlight">\(g\)</span>が相互作用してヒッグス粒子<span class="math notranslate nohighlight">\(h\)</span>を作り、それが2つのSUSY粒子<span class="math notranslate nohighlight">\(\chi^+\chi^-\)</span>に崩壊する過程を示しています。<span class="math notranslate nohighlight">\(\chi^+\)</span>粒子はさらに崩壊し、最終的には<span class="math notranslate nohighlight">\(\ell^+\ell^-\nu\nu\chi^0\chi^0\)</span>という終状態に落ち着くとします。右下の図は標準模型で存在が知られている過程を表していて、クォーク<span class="math notranslate nohighlight">\(q\)</span>と反クォーク<span class="math notranslate nohighlight">\(\bar{q}\)</span>が相互作用して<span class="math notranslate nohighlight">\(W\)</span>ボソン対を作り、それが<span class="math notranslate nohighlight">\(\ell^+\ell^-\nu\nu\)</span>に崩壊しています。</p>
<a class="reference internal image-reference" href="_images/susy_bg.png"><img alt="susy_bg" class="align-center" src="_images/susy_bg.png" style="width: 700px;" /></a>
<p>(図の引用：参考文献<span id="id8">[<a class="reference internal" href="bibliography.html#id26" title="P. Baldi, P. Sadowski, and D. Whiteson. Searching for exotic particles in high-energy physics with deep learning. Nature Communications, 5(1):4308, 2014. URL: https://doi.org/10.1038/ncomms5308, doi:10.1038/ncomms5308.">BSW14</a>]</span>)</p>
<p>左と右の過程を比べると、終状態の違いは<span class="math notranslate nohighlight">\(\chi^0\chi^0\)</span>が存在しているかどうかだけですね。この<span class="math notranslate nohighlight">\(\chi^0\)</span>という粒子は検出器と相互作用しないと考えられているので、この二つの過程の違いは（大雑把に言うと）実際の検出器では観測できないエネルギーの大きさにしかなく、探索することが難しい問題と考えることができます。以上のような状況で、この二つの物理過程を量子回路学習で分類できるかどうかを試みます。</p>
<section id="a-id-susy-data-a">
<h3><a class="toc-backref" href="#id23">学習データの準備<a id='susy_data'></a></a><a class="headerlink" href="#a-id-susy-data-a" title="Permalink to this heading">#</a></h3>
<p>学習に用いるデータは、カリフォルニア大学アーバイン校（UC Irvine）の研究グループが提供する<a class="reference external" href="https://archive.ics.uci.edu/ml/index.php">機械学習レポジトリ</a>の中の<a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/SUSY">SUSYデータセット</a>です。このデータセットの詳細は文献<span id="id9">[<a class="reference internal" href="bibliography.html#id26" title="P. Baldi, P. Sadowski, and D. Whiteson. Searching for exotic particles in high-energy physics with deep learning. Nature Communications, 5(1):4308, 2014. URL: https://doi.org/10.1038/ncomms5308, doi:10.1038/ncomms5308.">BSW14</a>]</span>に委ねますが、ある特定のSUSY粒子生成反応と、それに良く似た特徴を持つ背景事象を検出器で観測した時に予想される信号（運動学的変数）をシミュレートしたデータが含まれています。</p>
<p>探索に役立つ運動学的変数をどう選ぶかはそれ自体が大事な研究トピックですが、ここでは簡単のため、前もって役立つことを経験上知っている変数を使います。以下で、学習に使う運動学的変数を選んで、その変数を指定したサンプルを訓練用とテスト用に準備します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ファイルから変数を読み出す</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/SUSY_1K.csv&quot;</span><span class="p">,</span>
                 <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;isSignal&#39;</span><span class="p">,</span> <span class="s1">&#39;lep1_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep1_eta&#39;</span><span class="p">,</span> <span class="s1">&#39;lep1_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_eta&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;lep2_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_ene&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_phi&#39;</span><span class="p">,</span> <span class="s1">&#39;MET_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;axial_MET&#39;</span><span class="p">,</span> <span class="s1">&#39;M_R&#39;</span><span class="p">,</span> <span class="s1">&#39;M_TR_2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;MT2&#39;</span><span class="p">,</span> <span class="s1">&#39;S_R&#39;</span><span class="p">,</span> <span class="s1">&#39;M_Delta_R&#39;</span><span class="p">,</span> <span class="s1">&#39;dPhi_r_b&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_theta_r1&#39;</span><span class="p">))</span>

<span class="c1"># 学習に使う変数の数</span>
<span class="n">feature_dim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># dimension of each data point</span>

<span class="c1"># 3, 5, 7変数の場合に使う変数のセット</span>
<span class="k">if</span> <span class="n">feature_dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lep1_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_ene&#39;</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">feature_dim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
    <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lep1_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_ene&#39;</span><span class="p">,</span> <span class="s1">&#39;M_TR_2&#39;</span><span class="p">,</span> <span class="s1">&#39;M_Delta_R&#39;</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">feature_dim</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
    <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lep1_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep1_eta&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_pt&#39;</span><span class="p">,</span> <span class="s1">&#39;lep2_eta&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_ene&#39;</span><span class="p">,</span> <span class="s1">&#39;M_TR_2&#39;</span><span class="p">,</span> <span class="s1">&#39;M_Delta_R&#39;</span><span class="p">]</span>

<span class="c1"># 学習に使う事象数: trainは訓練用サンプル、testはテスト用サンプル</span>
<span class="n">train_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">df_sig</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isSignal</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">]</span>
<span class="n">df_bkg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isSignal</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">]</span>

<span class="c1"># サンプルの生成</span>
<span class="n">df_sig_train</span> <span class="o">=</span> <span class="n">df_sig</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
<span class="n">df_bkg_train</span> <span class="o">=</span> <span class="n">df_bkg</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
<span class="n">df_sig_test</span> <span class="o">=</span> <span class="n">df_sig</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="n">train_size</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">]</span>
<span class="n">df_bkg_test</span> <span class="o">=</span> <span class="n">df_bkg</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="n">train_size</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">]</span>
<span class="c1"># 最初のtrain_size事象がSUSY粒子を含む信号事象、残りのtrain_size事象がSUSY粒子を含まない背景事象</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">df_sig_train</span><span class="p">,</span> <span class="n">df_bkg_train</span><span class="p">])</span>
<span class="c1"># 最初のtest_size事象がSUSY粒子を含む信号事象、残りのtest_size事象がSUSY粒子を含まない背景事象</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">df_sig_test</span><span class="p">,</span> <span class="n">df_bkg_test</span><span class="p">])</span>

<span class="c1"># one-hotベクトル（信号事象では第1次元の第0要素が1、背景事象では第1次元の第1要素が1）</span>
<span class="n">train_label_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">train_label_one_hot</span><span class="p">[:</span><span class="n">train_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">train_label_one_hot</span><span class="p">[</span><span class="n">train_size</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">test_label_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">test_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">test_label_one_hot</span><span class="p">[:</span><span class="n">test_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">test_label_one_hot</span><span class="p">[</span><span class="n">test_size</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#datapoints, class_to_label = split_dataset_to_data_and_labels(test_input)</span>
<span class="c1">#datapoints_tr, class_to_label_tr = split_dataset_to_data_and_labels(training_input)</span>

<span class="n">mms</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">norm_train_data</span> <span class="o">=</span> <span class="n">mms</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">norm_test_data</span> <span class="o">=</span> <span class="n">mms</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-id-susy-state-preparation-a">
<h3><a class="toc-backref" href="#id24">量子状態の生成<a id='susy_state_preparation'></a></a><a class="headerlink" href="#a-id-susy-state-preparation-a" title="Permalink to this heading">#</a></h3>
<p>次は特徴量マップ<span class="math notranslate nohighlight">\(U_{\text{in}}(\mathbf{x}_i)\)</span>の作成ですが、ここでは参考文献<span id="id10">[<a class="reference internal" href="bibliography.html#id25" title="Vojtěch Havlíček, Antonio D. Córcoles, Kristan Temme, Aram W. Harrow, Abhinav Kandala, Jerry M. Chow, and Jay M. Gambetta. Supervised learning with quantum-enhanced feature spaces. Nature, 567(7747):209–212, 2019. URL: https://doi.org/10.1038/s41586-019-0980-2, doi:10.1038/s41586-019-0980-2.">HavlivcekCorcolesT+19</a>]</span>に従い、</p>
<div class="math notranslate nohighlight">
\[
U_{\phi_{\{k\}}}(\mathbf{x}_i)=\exp\left(i\phi_{\{k\}}(\mathbf{x}_i)Z_k\right)
\]</div>
<p>あるいは</p>
<div class="math notranslate nohighlight">
\[
U_{\phi_{\{l,m\}}}(\mathbf{x}_i)=\exp\left(i\phi_{\{l,m\}}(\mathbf{x}_i)Z_lZ_m\right)
\]</div>
<p>とします（<span class="math notranslate nohighlight">\(k\)</span>、<span class="math notranslate nohighlight">\(l\)</span>、<span class="math notranslate nohighlight">\(m\)</span>は入力値<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>のベクトル要素の添字）。この特徴量マップは、パウリZ演算子の形から前者をZ特徴量マップ、後者をZZ特徴量マップと呼ぶことがあります。ここで<span class="math notranslate nohighlight">\(\phi_{\{k\}}(\mathbf{x}_i)=x_i^{(k)}\)</span>（<span class="math notranslate nohighlight">\(x_i^{(k)}\)</span>は<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>の<span class="math notranslate nohighlight">\(k\)</span>番目要素）、<span class="math notranslate nohighlight">\(\phi_{\{l,m\}}(\mathbf{x}_i)=(\pi-x_i^{(l)})(\pi-x_i^{(m)})\)</span>（<span class="math notranslate nohighlight">\(x_i^{(l,m)}\)</span>は<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>の<span class="math notranslate nohighlight">\(l,m\)</span>番目要素）と決めて、入力値<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>を量子ビットに埋め込みます。Z特徴量マップは入力データの各要素を直接量子ビットに埋め込みます（つまり<span class="math notranslate nohighlight">\(\phi_{\{k\}}(\mathbf{x}_i)\)</span>は1入力に対して1量子ビットを使う）。ZZ特徴量マップは実際はZ特徴量マップを含む形で使うことが多いため、<span class="math notranslate nohighlight">\(\phi_{\{l,m\}}(\mathbf{x}_i)\)</span>の場合も<span class="math notranslate nohighlight">\(\phi_{\{k\}}(\mathbf{x}_i)\)</span>と同数の量子ビットに対して<span class="math notranslate nohighlight">\((l,m)\)</span>を循環的に指定して埋め込むことになります。ZZ特徴量マップでは量子ビット間にエンタングルメントを作っているため、古典計算では難しい特徴量空間へのマッピングになっていると考えられます。</p>
<p>この<span class="math notranslate nohighlight">\(U_\phi(\mathbf{x}_i)\)</span>にアダマール演算子を組み合わせることで、全体として、Z特徴量マップは</p>
<div class="math notranslate nohighlight">
\[
U_{\text{in}}(\mathbf{x}_i) = U_{\phi}(\mathbf{x}_i)H^{\otimes n},\:\:U_{\phi}(\mathbf{x}_i) = \exp\left(i\sum_{k=1}^nx_i^{(k)}Z_k\right)
\]</div>
<p>ZZ特徴量マップは</p>
<div class="math notranslate nohighlight">
\[
U_{\text{in}}(\mathbf{x}_i) = U_{\phi}(\mathbf{x}_i)H^{\otimes n},\:\:U_{\phi}(\mathbf{x}_i) = \exp\left(i\sum_{k=1}^n(\pi-x_i^{(k)})(\pi-x_i^{(k\%n+1)})Z_kZ_{k\%n+1}\right)\exp\left(i\sum_{k=1}^nx_i^{(k)}Z_k\right)
\]</div>
<p>となります。<span class="math notranslate nohighlight">\(U_{\phi}(\mathbf{x}_i)H^{\otimes n}\)</span>を複数回繰り返すことでより複雑な特徴量マップを作ることができるのは、上の例の場合と同じです。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#feature_map = ZFeatureMap(feature_dimension=feature_dim, reps=1)</span>
<span class="n">feature_map</span> <span class="o">=</span> <span class="n">ZZFeatureMap</span><span class="p">(</span><span class="n">feature_dimension</span><span class="o">=</span><span class="n">feature_dim</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">entanglement</span><span class="o">=</span><span class="s1">&#39;circular&#39;</span><span class="p">)</span>
<span class="n">feature_map</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/863b35ab98216df40f97d03d1b8e5ebf212dee2fa92ba679e505cdfa6478abea.png" src="_images/863b35ab98216df40f97d03d1b8e5ebf212dee2fa92ba679e505cdfa6478abea.png" />
</div>
</div>
</section>
<section id="a-id-susy-variational-form-a">
<h3><a class="toc-backref" href="#id25">変分フォームを使った状態変換<a id='susy_variational_form'></a></a><a class="headerlink" href="#a-id-susy-variational-form-a" title="Permalink to this heading">#</a></h3>
<p>変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>は上の初歩的な例で用いた回路とほぼ同じですが、回転ゲートとして</p>
<div class="math notranslate nohighlight">
\[
U_{\text{rot}}(\theta_j^l) = R_j^Z(\theta_{j2}^l)R_j^Y(\theta_{j1}^l)
\]</div>
<p>を使います。上の例では<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>を自分で組み立てましたが、Qiskitにはこの<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>を実装するAPIがすでに準備されているので、ここではそれを使います。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ansatz</span> <span class="o">=</span> <span class="n">TwoLocal</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">=</span><span class="n">feature_dim</span><span class="p">,</span> <span class="n">rotation_blocks</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ry&#39;</span><span class="p">,</span> <span class="s1">&#39;rz&#39;</span><span class="p">],</span> <span class="n">entanglement_blocks</span><span class="o">=</span><span class="s1">&#39;cz&#39;</span><span class="p">,</span> <span class="n">entanglement</span><span class="o">=</span><span class="s1">&#39;circular&#39;</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">#ansatz = TwoLocal(num_qubits=feature_dim, rotation_blocks=[&#39;ry&#39;], entanglement_blocks=&#39;cz&#39;, entanglement=&#39;circular&#39;, reps=3)</span>
<span class="n">ansatz</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0fd1ddf9b4bc566f6bae1f247037c7ff73eebae3eafbdbc58d94ba0136b2e4db.png" src="_images/0fd1ddf9b4bc566f6bae1f247037c7ff73eebae3eafbdbc58d94ba0136b2e4db.png" />
</div>
</div>
</section>
<section id="a-id-susy-measurement-a">
<h3><a class="toc-backref" href="#id26">測定とモデル出力<a id='susy_measurement'></a></a><a class="headerlink" href="#a-id-susy-measurement-a" title="Permalink to this heading">#</a></h3>
<p>測定やパラメータの最適化、コスト関数の定義も初歩的な例で用いたものとほぼ同じです。QiskitのVQCというクラスを用いるので、プログラムはかなり簡略化されています。</p>
<p>VQCクラスでは、特徴量マップと変分フォームを結合させ、入力特徴量とパラメータ値を代入し、測定を行い、目的関数を計算し、パラメータのアップデートを行う、という一連の操作を内部で行なってしまいます。測定を行うのに使用するのはSamplerというクラスで、これはEstimatorと同様の働きをしますが、後者が観測量の期待値を計算するのに対し、前者はすべての量子ビットをZ基底で測定した結果のビット列の確率分布を出力します。VQCではこの分布を利用して分類を行います。今回は2クラス分類なので、入力の各事象に対して、q0の測定値が0である確率が、それが信号事象である確率（モデルの予測）に対応します。</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 上のEstimatorと同じく、バックエンドを使わずシミュレーションを簡略化したSampler</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">()</span>

<span class="c1"># 実機で実行する場合</span>
<span class="c1"># instance = &#39;ibm-q/open/main&#39;</span>

<span class="c1"># try:</span>
<span class="c1">#     service = QiskitRuntimeService(channel=&#39;ibm_quantum&#39;, instance=instance)</span>
<span class="c1"># except AccountNotFoundError:</span>
<span class="c1">#     service = QiskitRuntimeService(channel=&#39;ibm_quantum&#39;, token=&#39;__paste_your_token_here__&#39;,</span>
<span class="c1">#                                    instance=instance)</span>

<span class="c1"># backend_name = &#39;ibm_washington&#39;</span>
<span class="c1"># session = Session(service=service, backend=backend_name)</span>

<span class="c1"># sampler = RuntimeSampler(session=session)</span>

<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">300</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">COBYLA</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">objective_func_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Draw the value of objective function every time when the fit() method is called</span>
<span class="k">def</span> <span class="nf">callback_graph</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">obj_func_eval</span><span class="p">):</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">objective_func_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_func_eval</span><span class="p">)</span>
    <span class="c1">#print(&#39;obj_func_eval =&#39;,obj_func_eval)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Objective function value against iteration&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Objective function value&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objective_func_vals</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">vqc</span> <span class="o">=</span> <span class="n">VQC</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">=</span><span class="n">feature_dim</span><span class="p">,</span>
          <span class="n">feature_map</span><span class="o">=</span><span class="n">feature_map</span><span class="p">,</span>
          <span class="n">ansatz</span><span class="o">=</span><span class="n">ansatz</span><span class="p">,</span>
          <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;cross_entropy&quot;</span><span class="p">,</span>
          <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
          <span class="n">callback</span><span class="o">=</span><span class="n">callback_graph</span><span class="p">,</span>
          <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vqc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_train_data</span><span class="p">,</span> <span class="n">train_label_one_hot</span><span class="p">)</span>

<span class="c1"># 実機で実行している（RuntimeSamplerを使っている）場合</span>
<span class="c1"># session.close()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Return from subroutine COBYLA because the MAXFUN limit has been reached.

   NFVALS =  300   F = 7.527796E-01    MAXCV = 0.000000E+00
   X = 2.769828E+00   2.690659E+00   2.209438E+00  -6.544334E-01   1.791658E+00
       5.891710E-01  -4.081896E-02   5.725357E-01   1.662590E+00  -5.402978E-01
       2.029238E+00   1.562530E-01   1.229339E+00   1.596802E+00   2.692169E-01
      -5.828812E-01   1.891610E+00   7.527701E-01  -6.604400E-01   1.587293E+00
       1.194641E+00   1.505717E-01
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_score</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">norm_train_data</span><span class="p">,</span> <span class="n">train_label_one_hot</span><span class="p">)</span>
<span class="n">test_score</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">norm_test_data</span><span class="p">,</span> <span class="n">test_label_one_hot</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Classification Train score: </span><span class="si">{</span><span class="n">train_score</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Classification Test score:  </span><span class="si">{</span><span class="n">test_score</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Classification Train score: 0.75 ---
--- Classification Test score:  0.275 ---
</pre></div>
</div>
</div>
</div>
<p>この結果を見てどう思うでしょうか？機械学習を知っている方であれば、この結果はあまり良いようには見えませんね。。訓練用のデータでは学習ができている、つまり信号とバックグラウンドの選別ができていますが、テスト用のサンプルでは選別性能が悪くなっています。これは「過学習」を起こしている場合に見られる典型的な症状で、訓練データのサイズに対して学習パラメータの数が多すぎるときによく起こります。</p>
<p>試しに、データサンプルの事象数を50や100に増やして実行し、結果を調べてみてください（処理時間は事象数に比例して長くなるので要注意）。</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "UTokyo-ICEPP/qc-workbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="vqe_tracking.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">【課題】高エネルギー実験で生成された荷電粒子の飛跡を見つける</p>
      </div>
    </a>
    <a class="right-next"
       href="qkc_machine_learning.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">【課題】量子カーネルを使った新現象の分類</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-introduction-a">はじめに <a id="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-ml-a">機械学習と深層学習 <a id="ml"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-qml-a">量子回路学習<a id="qml"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-example-a">初歩的な例<a id="example"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-data-a">学習データの準備<a id="func_data"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-state-preparation-a">量子状態の生成<a id="func_state_preparation"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-variational-form-a">変分フォームを使った状態変換<a id="func_variational_form"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#u-boldsymbol-theta">変分量子回路<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の構成</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2量子ビットゲートの作成</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">回転ゲートと<span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span>の作成</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-func-measurement-a">測定とモデル出力<a id="func_measurement"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-a">素粒子現象の探索への応用<a id="susy"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-data-a">学習データの準備<a id="susy_data"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-state-preparation-a">量子状態の生成<a id="susy_state_preparation"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-variational-form-a">変分フォームを使った状態変換<a id="susy_variational_form"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-id-susy-measurement-a">測定とモデル出力<a id="susy_measurement"></a></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By 東京大学素粒子物理国際研究センター
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>